<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout Demo</title>
</head>
<body>
    <form id="payment-form">
        <div id="card-element"></div>
        <button type="submit" id="submit-btn">Pay</button>
        <div role="alert" id="payment-message"></div>
    </form>
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        const stripe = Stripe('pk_test_51Ny7xyK3Pud6VeJGvQE29GrWcc7tjwgLzQO81GActX6kvu9Rxq7tyLUGYNcrumxU1muqlzIGagUoSwALglhQ6u9k00WIk9vAGh');

        let elements;
        let clientSecret;

        async function initialize() {
            const response = await fetch('/create-payment-intent', {
                method: 'POST',
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(
                    {
                        items: [
                            {
                                id: 't-shirt'
                            },
                            {
                                id: 'sneaker'
                            },
                        ],
                        currency: 'usd'
                    }
                ),
            });

            const data = await response.json();
            clientSecret = data.clientSecret;

            elements = stripe.elements({ clientSecret });
            const cardElement = elements.create('card');
            cardElement.mount("#card-element");
        }

        initialize();

        const form = document.getElementById("payment-form");
        form.addEventListener("submit", async (event) => {
            event.preventDefault();
            setLoading(true);

            const { error, paymentIntent } = await stripe.confirmCardPayment(
                clientSecret,
                {
                    payment_method: {
                        card: elements.getElement('card'),
                        billing_details: {
                            name: "Kha Nguyen",
                        }
                    }
                }
            )

            if (error) {
                showMessage(`Payment failed: ${error.message}`);
            } else {
                showMessage(`Payment: ${paymentIntent.status}`);
            }

            setLoading(false);
        });

        function showMessage(text) {
            const messageContainer = document.querySelector("#payment-message");
            messageContainer.textContent = text;
        }

        function setLoading(isLoading) {
            const submitBtn = document.querySelector("#submit-btn");
            submitBtn.disabled = isLoading;
        }
    </script>
</body>
</html>